# Prometheus Configuration for K2 Market Data Platform
# Scrapes metrics from Kafka, MinIO, and application services

global:
  scrape_interval: 15s      # How frequently to scrape targets
  evaluation_interval: 15s  # How frequently to evaluate rules
  external_labels:
    cluster: 'k2-market-data'
    environment: 'development'

# Alerting configuration (integrate with Alertmanager in production)
alerting:
  alertmanagers:
    - static_configs:
        - targets: []
          # - 'alertmanager:9093'  # Uncomment for production

# Load rules once and periodically evaluate them
rule_files:
  - "/etc/prometheus/rules/*.yml"  # Critical alert rules

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Kafka JMX metrics
  # Note: In production, use JMX Exporter sidecar
  - job_name: 'kafka'
    static_configs:
      - targets: ['kafka:9997']
    metric_relabel_configs:
      # Keep only relevant metrics to reduce cardinality
      - source_labels: [__name__]
        regex: 'kafka_(server|network|log|controller)_.*'
        action: keep

  # MinIO metrics (built-in Prometheus endpoint)
  - job_name: 'minio'
    metrics_path: /minio/v2/metrics/cluster
    scheme: http
    static_configs:
      - targets: ['minio:9000']

  # PostgreSQL metrics (requires postgres_exporter in production)
  # - job_name: 'postgres'
  #   static_configs:
  #     - targets: ['postgres-exporter:9187']

  # Application metrics (FastAPI service)
  # The K2 API exposes Prometheus metrics at /metrics
  - job_name: 'k2-api'
    static_configs:
      - targets: ['host.docker.internal:8000']  # host.docker.internal for local dev
    metrics_path: /metrics
    scrape_interval: 10s
    # Relabel to add job-specific labels
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'k2-api:8000'

  # Schema Registry metrics
  # Note: Requires JMX exporter configuration
  # - job_name: 'schema-registry'
  #   static_configs:
  #     - targets: ['schema-registry:8081']

# Remote write for long-term storage (optional, for production)
# remote_write:
#   - url: 'https://prometheus-remote-write-endpoint.example.com/api/v1/write'
#     basic_auth:
#       username: '${REMOTE_WRITE_USERNAME}'
#       password: '${REMOTE_WRITE_PASSWORD}'
