# K2 Market Data Platform v2 - Greenfield Architecture
# Version: 2.0.0-phase1
# Last Updated: 2026-02-09
# Target: 16 CPU cores / 40GB RAM

#############################################################################
# NETWORKS
#############################################################################
networks:
  k2-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

#############################################################################
# VOLUMES
#############################################################################
volumes:
  # Redpanda data
  redpanda-data:
    driver: local

  # ClickHouse data
  clickhouse-data:
    driver: local
  clickhouse-logs:
    driver: local

  # Monitoring data
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

#############################################################################
# SERVICES - STREAMING BACKBONE
#############################################################################
services:

  # ───────────────────────────────────────────────────────────────────────
  # Redpanda - Kafka-compatible streaming platform (C++, single binary)
  # ───────────────────────────────────────────────────────────────────────
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v25.3.4
    container_name: k2-redpanda
    hostname: redpanda
    networks:
      k2-net:
        ipv4_address: 172.28.0.10
    ports:
      - "9092:9092"     # Kafka API
      - "9644:9644"     # Admin API
      - "8081:8081"     # Schema Registry
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --memory 1500M
    environment:
      REDPANDA_PANDAPROXY_CLIENT_RETRIES: 5
      REDPANDA_PANDAPROXY_CLIENT_RETRY_BASE_BACKOFF_MS: 100
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy'"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    labels:
      com.k2.service: "streaming"
      com.k2.tier: "hot"
      com.k2.version: "v2"

  # ───────────────────────────────────────────────────────────────────────
  # Redpanda Console - Web UI for Redpanda/Kafka
  # ───────────────────────────────────────────────────────────────────────
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v3.5.1
    container_name: k2-redpanda-console
    hostname: console
    networks:
      - k2-net
    ports:
      - "8080:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
      KAFKA_SCHEMAREGISTRY_ENABLED: true
      KAFKA_SCHEMAREGISTRY_URLS: http://redpanda:8081
    depends_on:
      redpanda:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/admin/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      com.k2.service: "ui"
      com.k2.tier: "management"
      com.k2.version: "v2"

#############################################################################
# SERVICES - WARM STORAGE (ClickHouse)
#############################################################################

  # ───────────────────────────────────────────────────────────────────────
  # ClickHouse - OLAP database for real-time analytics
  # ───────────────────────────────────────────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:26.1
    container_name: k2-clickhouse
    hostname: clickhouse
    networks:
      k2-net:
        ipv4_address: 172.28.0.20
    ports:
      - "8123:8123"     # HTTP interface
      - "9000:9000"     # Native protocol
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./docker/clickhouse/config.xml:/etc/clickhouse-server/config.d/k2-config.xml:ro
      - ./docker/clickhouse/users.xml:/etc/clickhouse-server/users.d/k2-users.xml:ro
    environment:
      CLICKHOUSE_DB: k2
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    labels:
      com.k2.service: "storage"
      com.k2.tier: "warm"
      com.k2.version: "v2"

#############################################################################
# SERVICES - MONITORING & OBSERVABILITY
#############################################################################

  # ───────────────────────────────────────────────────────────────────────
  # Prometheus - Metrics collection
  # ───────────────────────────────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v3.2.0
    container_name: k2-prometheus
    hostname: prometheus
    networks:
      - k2-net
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      com.k2.service: "monitoring"
      com.k2.tier: "observability"
      com.k2.version: "v2"

  # ───────────────────────────────────────────────────────────────────────
  # Grafana - Metrics visualization
  # ───────────────────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:11.5.0
    container_name: k2-grafana
    hostname: grafana
    networks:
      - k2-net
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: ""
      GF_AUTH_ANONYMOUS_ENABLED: false
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_LOG_LEVEL: info
    depends_on:
      prometheus:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    labels:
      com.k2.service: "monitoring"
      com.k2.tier: "observability"
      com.k2.version: "v2"

#############################################################################
# RESOURCE SUMMARY (Phase 1 Baseline)
#############################################################################
# Service          | CPU Limit | Memory Limit | Purpose
# -----------------|-----------|--------------|---------------------------
# redpanda         | 2.0       | 2G           | Streaming backbone
# redpanda-console | 0.5       | 256M         | Streaming UI
# clickhouse       | 4.0       | 8G           | Warm storage OLAP
# prometheus       | 1.0       | 2G           | Metrics collection
# grafana          | 0.5       | 512M         | Visualization
# -----------------|-----------|--------------|---------------------------
# TOTAL            | 8.0 CPU   | 12.75 GB     | Phase 1 baseline
#
# Remaining budget: 8.0 CPU / 27.25 GB for future phases
# Target: 16 CPU / 40 GB total
#############################################################################
