# K2 Market Data Platform v2 - Prometheus Configuration
# Scrapes metrics from all v2 services

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'k2-v2'
    environment: 'development'

# Alertmanager configuration (future)
alerting:
  alertmanagers:
    - static_configs:
        - targets: []

# Load rules (alerting and recording rules)
rule_files:
  - "rules/*.yml"

# Scrape configurations
scrape_configs:

  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          tier: 'observability'

  # Redpanda metrics
  - job_name: 'redpanda'
    static_configs:
      - targets: ['redpanda:9644']
        labels:
          service: 'redpanda'
          tier: 'streaming'
    metrics_path: '/metrics'
    scrape_interval: 10s

  # ClickHouse metrics (Prometheus endpoint on port 8123 at /metrics)
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['clickhouse:9363']
        labels:
          service: 'clickhouse'
          tier: 'warm-storage'
    metrics_path: '/metrics'
    scrape_interval: 15s

  # Grafana
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          tier: 'observability'
    metrics_path: '/metrics'

  # Future: Spring Boot API (actuator metrics)
  # - job_name: 'k2-api'
  #   static_configs:
  #     - targets: ['k2-api:8081']
  #   metrics_path: '/actuator/prometheus'

  # Iceberg Offload Scheduler — retired; Prefect worker handles offloads in v2
  # Kept as reference; remove if Prometheus flags down alert becomes noise
  # - job_name: 'iceberg-scheduler'
  #   static_configs:
  #     - targets: ['host.docker.internal:8000']

  # Kotlin feed handlers — Micrometer Prometheus endpoint on port 8082
  - job_name: 'feed-handler-binance'
    static_configs:
      - targets: ['feed-handler-binance:8082']
        labels:
          service: 'feed-handler-binance'
          exchange: 'binance'
          tier: 'ingestion'
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'feed-handler-kraken'
    static_configs:
      - targets: ['feed-handler-kraken:8082']
        labels:
          service: 'feed-handler-kraken'
          exchange: 'kraken'
          tier: 'ingestion'
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'feed-handler-coinbase'
    static_configs:
      - targets: ['feed-handler-coinbase:8082']
        labels:
          service: 'feed-handler-coinbase'
          exchange: 'coinbase'
          tier: 'ingestion'
    metrics_path: '/metrics'
    scrape_interval: 10s
