# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# K2 Feed Handler Configuration
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Uses HOCON format with environment variable substitution
# Follows 12-factor app principles: config via environment, sensible defaults
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

k2 {
  feed-handler {
    # Exchange identifier (binance, kraken, etc.)
    # Override: K2_EXCHANGE
    exchange = "binance"
    exchange = ${?K2_EXCHANGE}

    # Symbol loading priority:
    # 1. K2_INSTRUMENTS_FILE env var → reads config/instruments.yaml for this exchange
    # 2. K2_SYMBOLS env var → comma-separated fallback (e.g. "BTCUSDT,ETHUSDT")
    # 3. symbols list below → hardcoded defaults (local dev only)
    symbols = ["BTCUSDT", "ETHUSDT", "BNBUSDT"]
    symbols = ${?K2_SYMBOLS}

    # Schema base path for Avro schemas
    # Override: K2_SCHEMA_PATH
    schema-path = "/app/schemas"
    schema-path = ${?K2_SCHEMA_PATH}

    binance {
      # Binance WebSocket URL for SUBSCRIBE method
      # Override: K2_BINANCE_WS_URL
      # Note: Use /ws endpoint (not /stream) for subscription-based approach
      websocket-url = "wss://stream.binance.com:9443/ws"
      websocket-url = ${?K2_BINANCE_WS_URL}

      reconnect-delay-ms = 5000
      max-reconnect-attempts = -1  # -1 = infinite retries
      ping-interval-ms = 30000
    }

    kraken {
      # Kraken WebSocket URL
      # Override: K2_KRAKEN_WS_URL
      websocket-url = "wss://ws.kraken.com"
      websocket-url = ${?K2_KRAKEN_WS_URL}

      reconnect-delay-ms = 5000
      max-reconnect-attempts = -1  # -1 = infinite retries
      ping-interval-ms = 30000
    }

    coinbase {
      # Coinbase Advanced Trade WebSocket URL (no auth required for public channels)
      # Override: K2_COINBASE_WS_URL
      websocket-url = "wss://advanced-trade-ws.coinbase.com"
      websocket-url = ${?K2_COINBASE_WS_URL}

      reconnect-delay-ms = 5000
      max-reconnect-attempts = -1  # -1 = infinite retries
      ping-interval-ms = 30000
    }

    kafka {
      # Kafka/Redpanda bootstrap servers
      # Override: K2_KAFKA_BOOTSTRAP_SERVERS
      # Default: localhost for local dev, redpanda:9092 in containers
      bootstrap-servers = "localhost:9092"
      bootstrap-servers = ${?K2_KAFKA_BOOTSTRAP_SERVERS}

      # Schema Registry URL (Confluent compatible)
      # Override: K2_KAFKA_SCHEMA_REGISTRY_URL
      schema-registry-url = "http://localhost:8081"
      schema-registry-url = ${?K2_KAFKA_SCHEMA_REGISTRY_URL}

      producer {
        # Idempotent producer for exactly-once semantics
        acks = "all"
        retries = 3
        linger-ms = 10
        batch-size = 16384
        compression-type = "lz4"
        max-in-flight-requests-per-connection = 5
        enable-idempotence = true
      }

      topics {
        # Raw topic: immutable exchange-specific format
        # Override: K2_KAFKA_TOPIC_RAW
        raw = "market.crypto.trades."${k2.feed-handler.exchange}".raw"
        raw = ${?K2_KAFKA_TOPIC_RAW}

        # Normalized topic: canonical format across exchanges
        # Override: K2_KAFKA_TOPIC_NORMALIZED
        normalized = "market.crypto.trades."${k2.feed-handler.exchange}
        normalized = ${?K2_KAFKA_TOPIC_NORMALIZED}
      }
    }

    metrics {
      enabled = true
      log-interval-seconds = 60
    }
  }
}
