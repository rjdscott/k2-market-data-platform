# Start-of-Day Brief — 2026-02-20

**Date:** 2026-02-20
**Branch:** `main`
**Phase:** 7 — Integration Hardening (3/5 steps complete)

> Read this first. Everything you need to start work is here.
> Full session narrative: [HANDOFF-2026-02-19.md](HANDOFF-2026-02-19.md)

---

## Current Status

```
• [x] Phase 5: Cold Tier / Iceberg Offload — COMPLETE
• [x] Phase 6: Kotlin Feed Handlers — COMPLETE
• [ ] Phase 7: Integration Hardening — ACTIVE (3/5 steps)
  • [x] Step 1: Latency Benchmark — COMPLETE (p99 ≤197ms all exchanges)
  • [~] Step 2: Resource Validation — BURN-IN RUNNING OVERNIGHT (PID 107291)
  • [x] Step 3: Failure Mode Testing — COMPLETE (all 6 pass, max MTTR 32s)
  • [~] Step 4: Monitoring & Alerting — 80% DONE (alert rules live, dashboard committed)
  • [ ] Step 5: Runbooks & Documentation Finalisation — not started
```

---

## First Things to Do

### 1. Check the stack is healthy

```bash
docker compose -f docker-compose.v2.yml ps
# All 13 services should be Up
```

Quick data check:
```bash
docker exec k2-clickhouse clickhouse-client \
  --query "SELECT exchange, count(), max(ingestion_timestamp) FROM k2.silver_trades GROUP BY exchange"
```

### 2. Collect the 24h burn-in results

The sampling loop started yesterday at ~09:53 local (22:53 UTC).

```bash
# Check it's still running
ps aux | grep k2-burn-in

# View latest samples
tail -20 /tmp/k2-burn-in.csv

# Parse averages (CPU% and MiB per service)
awk -F',' 'NF==4 {sum[$1]+=$2; count[$1]++} END {for (s in sum) printf "%s: avg CPU %.2f%%\n", s, sum[s]/count[s]}' \
  /tmp/k2-burn-in.csv | sort
```

Record results in `docs/phases/v2/phase-7-integration-hardening/PROGRESS.md` resource table.

---

## Today's Work: Step 4 Completion + Step 5

### Priority 1: Complete Step 4 — Monitoring & Alerting

**What's done (2026-02-19):**
- `docker/prometheus/rules/feed-handler-alerts.yml` — FeedHandlerDown, FeedHandlerHighErrorRate, FeedHandlerFrequentReconnects
- `docker/prometheus/rules/clickhouse-alerts.yml` — ClickHouseDown, ClickHouseHighMemoryUsage, ClickHouseBronzeInsertRateLow
- `docker/grafana/dashboards/k2-pipeline-overview.json` — 5-section dashboard (Stack Health, Feed Handlers, ClickHouse, Iceberg, Redpanda)
- Prometheus scraping all feed handlers on port 8082 (Micrometer) ✅
- ClickHouse Prometheus endpoint on port 9363 ✅

**What's still needed for Step 4:**
1. **Test that FeedHandlerDown alert fires** — stop a feed handler and wait 2 min, confirm Prometheus shows FIRING:
   ```bash
   docker compose -f docker-compose.v2.yml stop feed-handler-binance
   # Wait 2+ minutes
   # Check: http://localhost:9090/alerts — should show FeedHandlerDown FIRING
   docker compose -f docker-compose.v2.yml start feed-handler-binance
   ```

2. **Alertmanager setup** (currently no alertmanager running — alerts evaluate but don't route):
   - Optional for this phase: add a simple Alertmanager container with email/Slack webhook
   - Minimum viable: leave as-is and document in runbooks that alerts are visible at http://localhost:9090/alerts

3. **Grafana dashboard review** — open http://localhost:3000, navigate to K2 Platform v2 folder, verify `K2 Pipeline Overview` loads panels with data.

4. **Update step-04 file** — mark acceptance criteria as met

### Priority 2: Step 5 — Runbooks + Documentation Finalisation

**Full spec:** [step-05-runbooks-documentation.md](phase-7-integration-hardening/steps/step-05-runbooks-documentation.md)

5 runbooks to write (2 hours):
1. `feed-handler-recovery.md` — crash, reconnect loops, instrument config issues
2. `clickhouse-recovery.md` — restart, memory OOM, Kafka consumer stall
3. `redpanda-recovery.md` — restart, topic deletion, consumer lag
4. `iceberg-offload-failure.md` — already referenced in existing alert rules, write the actual file
5. `on-call-guide.md` — first-response checklist, escalation paths, key URLs

Then:
- Update `ARCHITECTURE-V2.md` with measured latency values (p99 ~200ms) and actual resource numbers
- Create git tag: `git tag v2-phase-7-complete`

---

## Key Context for Today

### Prometheus Alert Rules (what's live)
- **iceberg-offload-alerts.yml** — lag, failures, scheduler down, cycle duration
- **feed-handler-alerts.yml** — FeedHandlerDown (2min silence), high error rate, frequent reconnects
- **clickhouse-alerts.yml** — CH down, high memory, low insert rate, merge queue

Check at: http://localhost:9090/alerts

### ClickHouse Prometheus (new as of yesterday)
- Port: 9363 — now scraping `ClickHouseProfileEvents_*`, `ClickHouseAsynchronousMetrics_*`
- Config: `docker/clickhouse/config.xml` (added `<prometheus>` section)
- Takes effect on `docker compose up -d --force-recreate --no-deps clickhouse`

### Feed Handler Metrics (new as of yesterday)
- Port: 8082 `/metrics` on each feed handler container
- Metrics: `feed_handler_trades_produced_total{exchange,type}`, `feed_handler_errors_total{exchange}`, `feed_handler_reconnects_total{exchange}`
- Dashboard: `K2 Pipeline Overview` in Grafana → K2 Platform v2 folder

### Prefect Worker RAM Warning
- At startup: 488MiB / 512MiB (95%)
- After 30 min idle: 100MiB (normal)
- If prefect-worker OOMs during burn-in: increase limit in docker-compose.v2.yml from 512MB → 768MB

### Burn-in Data
- File: `/tmp/k2-burn-in.csv`
- Sampling: every 5 minutes since ~09:53 local
- PID: 107291 (verify still running with `ps aux | grep 107291`)

---

## End-of-Day Targets for 2026-02-20

```
• [ ] Step 2: Collect 24h burn-in results and fill in PROGRESS.md resource table
• [ ] Step 4: FeedHandlerDown alert fire test completed
• [ ] Step 4: Grafana dashboard reviewed and working
• [ ] Step 4: step-04 file marked ✅ Complete
• [ ] Step 5: All 5 runbooks written
• [ ] Step 5: ARCHITECTURE-V2.md updated with measured values
• [ ] Step 5: Git tag v2-phase-7-complete created
• [ ] CURRENT-STATE.md updated (Phase 7 = ✅ Complete)
• [ ] This HANDOFF updated → HANDOFF-2026-02-21.md
```

---

## Related Docs

- [Phase 7 PROGRESS](phase-7-integration-hardening/PROGRESS.md)
- [Step 4: Monitoring & Alerting](phase-7-integration-hardening/steps/step-04-monitoring-alerting.md)
- [Step 5: Runbooks](phase-7-integration-hardening/steps/step-05-runbooks-documentation.md)
- [CURRENT-STATE.md](CURRENT-STATE.md)
- [HANDOFF-2026-02-19.md](HANDOFF-2026-02-19.md) — yesterday's full session log
