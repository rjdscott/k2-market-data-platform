# Start-of-Day Brief — 2026-02-19

**Date:** 2026-02-19
**Branch:** `main`
**Phase:** 7 — Integration Hardening (0/5 steps complete)

> Read this first. Everything you need to start work is here.
> Full session narrative: [HANDOFF-2026-02-18.md](HANDOFF-2026-02-18.md)

---

## Current Status

```
• [x] Phase 5: Cold Tier / Iceberg Offload — COMPLETE (tagged v2-phase-5-complete)
• [x] Phase 6: Kotlin Feed Handlers — COMPLETE
• [ ] Phase 7: Integration Hardening — ACTIVE (0/5 steps)
  • [ ] Step 1: Latency Benchmark
  • [ ] Step 2: Resource Validation (24h burn-in)
  • [ ] Step 3: Failure Mode Testing
  • [ ] Step 4: Monitoring & Alerting
  • [ ] Step 5: Runbooks & Documentation Finalisation
```

---

## Start Here: Confirm Stack is Healthy

```bash
docker compose -f docker-compose.v2.yml ps
```

All 13 services should be `Up`. If anything is down:

```bash
docker compose -f docker-compose.v2.yml up -d
```

Quick data sanity check:
```bash
# Trades still flowing?
docker exec k2-clickhouse clickhouse-client \
  --query "SELECT exchange, count(), max(ingestion_timestamp) FROM k2.silver_trades GROUP BY exchange"

# Iceberg offloads still running?
docker exec k2-clickhouse clickhouse-client \
  --password "${CLICKHOUSE_PASSWORD}" \
  --query "SELECT source_table, last_watermark FROM offload_watermarks ORDER BY source_table" \
  2>/dev/null || docker exec k2-prefect-db psql -U prefect -c \
  "SELECT source_table, last_watermark, updated_at FROM offload_watermarks ORDER BY source_table;"

# Prefect schedule healthy?
# Open http://localhost:4200 — check iceberg-offload-15min shows recent COMPLETED runs
```

---

## Today's Work: Phase 7 Steps 1–3

Recommended approach: run Steps 1 and 3 today, let Step 2 (24h burn-in) run overnight.

### Priority 1: Step 1 — Latency Benchmark

**Full spec:** [step-01-latency-benchmark.md](phase-7-integration-hardening/steps/step-01-latency-benchmark.md)

**Quick start** — measure exchange_timestamp → ingestion_timestamp lag right now:
```sql
-- ClickHouse: end-to-end lag for last 5 minutes
SELECT
  exchange,
  avg(ingestion_timestamp - exchange_timestamp) AS avg_lag_ms,
  quantile(0.99)(ingestion_timestamp - exchange_timestamp) AS p99_lag_ms,
  max(ingestion_timestamp - exchange_timestamp) AS max_lag_ms
FROM k2.silver_trades
WHERE timestamp > now() - INTERVAL 5 MINUTE
GROUP BY exchange;
```

**Target**: p99 < 200ms at baseline (~50 msg/s). Record results in step-01 file.

Also check MV processing via `system.query_log`:
```sql
SELECT
  avg(query_duration_ms) AS avg_mv_ms,
  max(query_duration_ms) AS max_mv_ms
FROM system.query_log
WHERE query_kind = 'INSERT'
  AND tables LIKE '%bronze_trades%'
  AND event_time > now() - INTERVAL 10 MINUTE
  AND type = 'QueryFinish';
```

### Priority 2: Start Step 2 — 24h Burn-In (leave running overnight)

**Full spec:** [step-02-resource-validation.md](phase-7-integration-hardening/steps/step-02-resource-validation.md)

Start the sampling loop **early** so 24h of data is available tomorrow morning:
```bash
# Run in background — captures docker stats every 5 minutes
while true; do
  echo "$(date -Iseconds)" >> /tmp/k2-burn-in.csv
  docker stats --no-stream --format "{{.Name}},{{.CPUPerc}},{{.MemUsage}}" \
    >> /tmp/k2-burn-in.csv
  sleep 300
done &
echo "Burn-in sampling started. PID: $!"
```

Take an immediate snapshot baseline:
```bash
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

### Priority 3: Step 3 — Failure Mode Testing

**Full spec:** [step-03-failure-mode-testing.md](phase-7-integration-hardening/steps/step-03-failure-mode-testing.md)

Run the 6 failure tests in order. Each takes 2–5 minutes. Start with the lowest-risk:

1. **Feed handler crash** (safest — only 1 exchange affected):
   ```bash
   docker compose -f docker-compose.v2.yml stop feed-handler-binance
   # Check Kraken + Coinbase still flowing, then restart:
   docker compose -f docker-compose.v2.yml start feed-handler-binance
   ```

2. **Redpanda restart** (buffering test):
   ```bash
   docker compose -f docker-compose.v2.yml restart redpanda
   # Watch for CH consumers to resume
   ```

3. **ClickHouse restart** (MV recovery test):
   ```bash
   docker compose -f docker-compose.v2.yml restart clickhouse
   ```

4. **Spark / offload failure** (idempotency test):
   ```bash
   docker compose -f docker-compose.v2.yml stop spark-iceberg
   # Let next Prefect run fail, then check watermarks didn't advance
   docker compose -f docker-compose.v2.yml start spark-iceberg
   ```

5. **MinIO unavailable** (cold tier isolation test):
   ```bash
   docker compose -f docker-compose.v2.yml stop minio
   # Verify CH hot tier unaffected; restart MinIO; verify next offload succeeds
   docker compose -f docker-compose.v2.yml start minio
   ```

6. **Network partition** (last — requires docker network commands; potentially disruptive):
   ```bash
   docker network disconnect k2-market-data-platform_default k2-clickhouse
   sleep 30
   docker network connect k2-market-data-platform_default k2-clickhouse
   ```

Record MTTR and pass/fail for each in the step-03 file.

---

## Steps 4–5: Later This Week

| Step | When | Estimated effort |
|------|------|-----------------|
| Step 4: Monitoring & Alerting | Tomorrow / day after | ~3h: add dashboard panels, write alert rules, test each fires |
| Step 5: Runbooks + Doc Finalisation | End of week | ~2h: 5 runbooks, update ARCHITECTURE-V2.md with measured values, tag v2-phase-7-complete |

---

## Key Context

**Branch:** `main` — all Phase 5 work is merged. Start Phase 7 work directly on main or a feature branch (`phase-7-integration-hardening`).

**Prefect schedules running:**
- Offload: `iceberg-offload-15min` (cron `*/15 * * * *`) — every 15 min
- Maintenance: `iceberg-maintenance-daily` (cron `0 2 * * *`) — 02:00 UTC

**ClickHouse password:** in `.env` as `CLICKHOUSE_PASSWORD`

**Known gotcha — inode staleness:** If you edit `config/instruments.yaml`, run:
```bash
docker compose up -d --force-recreate --no-deps feed-handler-<exchange>
```
NOT `docker restart` — that doesn't re-mount the file.

**Kotlin tests:** Run via Docker if needed (no `gradlew` in project):
```bash
docker run --rm \
  -v /home/rjdscott/Documents/projects/k2-market-data-platform:/project \
  -w /project/services/feed-handler-kotlin \
  -e GRADLE_USER_HOME=/tmp/.gradle \
  gradle:8.12-jdk21 gradle test --no-daemon --rerun-tasks
```

---

## End-of-Day Targets for 2026-02-19

```
• [ ] Step 1: Latency benchmark measured and results recorded
• [ ] Step 2: 24h burn-in sampling loop started (runs overnight)
• [ ] Step 3: All 6 failure modes tested with MTTR recorded
• [ ] Phase 7 PROGRESS.md updated with steps 1/3 complete
```

---

## Related Docs

- [Phase 7 README](phase-7-integration-hardening/README.md)
- [Phase 7 PROGRESS](phase-7-integration-hardening/PROGRESS.md)
- [CURRENT-STATE.md](CURRENT-STATE.md) — platform snapshot
- [HANDOFF-2026-02-18.md](HANDOFF-2026-02-18.md) — full yesterday session log
