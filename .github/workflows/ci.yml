name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.13'
  UV_CACHE_DIR: '${{ github.workspace }}/.uv-cache'

jobs:
  # =============================================================================
  # Validation Stage
  =============================================================================
  validate:
    name: Validate (${{ matrix.task }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        task: [lint, type-check, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: '${{ runner.os }}-uv-${{ hashFiles(''**/pyproject.toml'') }}'
          restore-keys: |
            ${{ runner.os }}-uv-
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv sync --all-extras
      
      - name: Run validation
        run: |
          case "${{ matrix.task }}" in
            "lint")
              echo "Running code linting..."
          uv run ruff check src/ tests/ --exclude=tests/unit/test_consumer_legacy.py --output-format=junit > lint-report.xml || true
              uv run black --check src/ tests/ || true
              uv run isort --check-only src/ tests/ || true
              uv run mypy src/ --junit-xml type-check-report.xml || true
              ;;
            "security-scan")
              echo "Running security scanning..."
              uv run bandit -r src/ -f json -o security-report.json || true
              uv run safety check --json --output security-report.json || true
              ;;
          esac
      
      - name: Upload validation reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: validation-reports-${{ matrix.task }}
          path: |
            lint-report.xml
            type-check-report.xml
            security-report.json
            safety-report.json